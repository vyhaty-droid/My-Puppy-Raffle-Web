<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PuppyRaffle DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      padding: 40px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #4b6cb7;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      background-color: #4b6cb7;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #35509a;
    }
    input, textarea {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    .admin-only {
      border-top: 1px solid #ddd;
      margin-top: 20px;
      padding-top: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ¶ PuppyRaffle</h1>

  <div class="section">
    <button onclick="connectWallet()">ğŸ”Œ Connect Wallet</button>
    <p><strong>Connected Wallet:</strong> <span id="walletAddress">Not connected</span></p>
    <p><strong>Contract Address:</strong> <span id="contractAddress">Not set</span></p>
    <p><strong>Status:</strong> <span id="statusText">-</span></p>
  </div>

  <div class="section">
    <h3>ğŸŸï¸ Enter Raffle</h3>
    <textarea id="playerList" placeholder="Enter player addresses (comma-separated)"></textarea>
    <button onclick="enterRaffle()">Enter</button>
  </div>

  <div class="section">
    <h3>ğŸ’¸ Refund</h3>
    <input type="number" id="refundIndex" placeholder="Player Index">
    <button onclick="refund()">Refund</button>
  </div>

  <div class="section">
  <h3>ğŸ” Get My Player Index</h3>
  <button onclick="getMyIndex()">Check Index</button>
  <p id="myIndexResult">Your index will appear here.</p>
  </div>

  <div class="section">
  <h3>ğŸ¨ My NFTs</h3>
  <button onclick="loadMyNFTs()">Load My NFTs</button>
  <div id="nftContainer"></div>
  </div>


  <div class="section admin-only hidden" id="adminSection">
    <h3>ğŸ”’ Admin Actions</h3>
    <button onclick="selectWinner()">ğŸ† Select Winner</button>
    <button onclick="withdrawFees()">ğŸ’° Withdraw Fees</button>
    <input type="text" id="newFeeAddress" placeholder="New Fee Address">
    <button onclick="changeFeeAddress()">âœï¸ Change Fee Address</button>
  </div>

  <script>
    let web3;
    let account;
    let contract;
    const contractAddress = "0xYourContractAddressHere"; // <-- Replace this with actual deployed address
    const abi = [ /* â† Replace this with ABI */ ];

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];
        document.getElementById("walletAddress").innerText = account;

        contract = new web3.eth.Contract(abi, contractAddress);
        document.getElementById("contractAddress").innerText = contractAddress;

        const owner = await contract.methods.owner().call();
        if (owner.toLowerCase() === account.toLowerCase()) {
          document.getElementById("adminSection").classList.remove("hidden");
          document.getElementById("statusText").innerText = "Connected as ADMIN (Owner)";
        } else {
          document.getElementById("statusText").innerText = "Connected as USER";
        }
      } else {
        alert("Please install MetaMask to use this DApp.");
      }
    }

    async function enterRaffle() {
      const rawPlayers = document.getElementById("playerList").value;
      const players = rawPlayers.split(",").map(p => p.trim()).filter(p => p !== "");
      const fee = await contract.methods.entranceFee().call();
      const total = BigInt(fee) * BigInt(players.length);
      try {
        await contract.methods.enterRaffle(players).send({
          from: account,
          value: total.toString()
        });
        alert("Entered successfully!");
      } catch (err) {
        alert("âŒ Error entering: " + err.message);
      }
    }

    // ğŸ§  HÃ m thÃ´ng minh kiá»ƒm tra "0" cÃ³ pháº£i index tháº­t khÃ´ng
  async function getMyIndex() {
  if (!contract || !account) return;
  try {
    const idx = await contract.methods.getActivePlayerIndex(account).call();
    if (Number(idx) === 0) {
      const first = await contract.methods.players(0).call();
      if (first.toLowerCase() === account.toLowerCase()) {
        document.getElementById("myIndexResult").innerText = "ğŸ¯ You are player at index: 0";
      } else {
        document.getElementById("myIndexResult").innerText = "âŒ You are not currently in the raffle.";
      }
    } else {
      document.getElementById("myIndexResult").innerText = "ğŸ¯ You are player at index: " + idx;
    }
  } catch (err) {
    console.error(err);
    document.getElementById("myIndexResult").innerText = "âŒ Error checking index.";
    }
  }

  // ğŸ–¼ï¸ HÃ m hiá»ƒn thá»‹ NFT mÃ  báº¡n Ä‘ang sá»Ÿ há»¯u
  async function loadMyNFTs() {
  if (!contract || !account) return;

  const nftContainer = document.getElementById("nftContainer");
  nftContainer.innerHTML = "ğŸ”„ Loading...";

  try {
    const transfers = await contract.getPastEvents("Transfer", {
      filter: { to: account },
      fromBlock: 0,
      toBlock: "latest"
    });

    const tokenIds = transfers.map(t => t.returnValues.tokenId);
    if (tokenIds.length === 0) {
      nftContainer.innerHTML = "ğŸ˜” You don't own any Puppy NFTs yet.";
      return;
    }

    nftContainer.innerHTML = "";

    for (const id of tokenIds) {
      const uri = await contract.methods.tokenURI(id).call();
      const base64 = uri.split(",")[1];
      const json = JSON.parse(atob(base64));

      // image IPFS gateway fallback
      let imgUrl = json.image;
      if (imgUrl.startsWith("ipfs://")) {
        imgUrl = imgUrl.replace("ipfs://", "https://ipfs.io/ipfs/");
      }

      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.borderRadius = "10px";
      div.style.padding = "10px";
      div.style.marginBottom = "15px";
      div.style.background = "#fafafa";
      div.innerHTML = `
        <strong>${json.name} #${id}</strong><br>
        <em>Rarity:</em> ${json.attributes[0].value}<br><br>
        <img src="${imgUrl}" alt="NFT Image" style="max-width: 200px; border-radius: 10px;">
      `;
      nftContainer.appendChild(div);
    }
   } catch (err) {
    console.error(err);
    nftContainer.innerHTML = "âŒ Error loading NFTs.";
    }
   }


    async function refund() {
      const index = document.getElementById("refundIndex").value;
      try {
        await contract.methods.refund(index).send({ from: account });
        alert("Refund successful!");
      } catch (err) {
        alert("âŒ Error refunding: " + err.message);
      }
    }

    async function selectWinner() {
      try {
        await contract.methods.selectWinner().send({ from: account });
        alert("Winner selected!");
      } catch (err) {
        alert("âŒ Error selecting winner: " + err.message);
      }
    }

    async function withdrawFees() {
      try {
        await contract.methods.withdrawFees().send({ from: account });
        alert("Fees withdrawn!");
      } catch (err) {
        alert("âŒ Error withdrawing fees: " + err.message);
      }
    }

    async function changeFeeAddress() {
      const newAddress = document.getElementById("newFeeAddress").value;
      try {
        await contract.methods.changeFeeAddress(newAddress).send({ from: account });
        alert("Fee address changed!");
      } catch (err) {
        alert("âŒ Error changing fee address: " + err.message);
      }
    }
  </script>
</body>
</html>

