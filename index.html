<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PuppyRaffle DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      padding: 40px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #4b6cb7;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      background-color: #4b6cb7;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #35509a;
    }
    input, textarea {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    .admin-only {
      border-top: 1px solid #ddd;
      margin-top: 20px;
      padding-top: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ¶ PuppyRaffle</h1>

  <div class="section">
    <button onclick="connectWallet()">ğŸ”Œ Connect Wallet</button>
    <p><strong>Connected Wallet:</strong> <span id="walletAddress">Not connected</span></p>
    <p><strong>Contract Address:</strong> <span id="contractAddress">Not set</span></p>
    <p><strong>Status:</strong> <span id="statusText">-</span></p>
  </div>

  <div class="section">
    <h3>ğŸŸï¸ Enter Raffle</h3>
    <textarea id="playerList" placeholder="Enter player addresses (comma-separated)"></textarea>
    <button onclick="enterRaffle()">Enter</button>
  </div>

  <div class="section">
    <h3>ğŸ’¸ Refund</h3>
    <input type="number" id="refundIndex" placeholder="Player Index">
    <button onclick="refund()">Refund</button>
  </div>

  <div class="section">
  <h3>ğŸ” Get My Player Index</h3>
  <button onclick="getMyIndex()">Check Index</button>
  <p id="myIndexResult">Your index will appear here.</p>
  </div>

  <div class="section">
  <h3>ğŸ¨ My NFTs</h3>
  <button onclick="loadMyNFTs()">Load My NFTs</button>
  <div id="nftContainer"></div>
  </div>


  <div class="section admin-only hidden" id="adminSection">
    <h3>ğŸ”’ Admin Actions</h3>
    <button onclick="selectWinner()">ğŸ† Select Winner</button>
    <button onclick="withdrawFees()">ğŸ’° Withdraw Fees</button>
    <input type="text" id="newFeeAddress" placeholder="New Fee Address">
    <button onclick="changeFeeAddress()">âœï¸ Change Fee Address</button>
  </div>

  <script>
    let web3;
    let account;
    let contract;
    const contractAddress = "0x326a5c6436d02Ee9C0137cc02163373A4dEfA6EA"; // <-- Replace this with actual deployed address
    const abi = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_entranceFee",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "_feeAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_raffleDuration",
				"type": "uint256"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "approved",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "ApprovalForAll",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newFeeAddress",
				"type": "address"
			}
		],
		"name": "changeFeeAddress",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "newPlayers",
				"type": "address[]"
			}
		],
		"name": "enterRaffle",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "newFeeAddress",
				"type": "address"
			}
		],
		"name": "FeeAddressChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address[]",
				"name": "newPlayers",
				"type": "address[]"
			}
		],
		"name": "RaffleEnter",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "player",
				"type": "address"
			}
		],
		"name": "RaffleRefunded",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "playerIndex",
				"type": "uint256"
			}
		],
		"name": "refund",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "_data",
				"type": "bytes"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "selectWinner",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "setApprovalForAll",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdrawFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "addressToRaffleId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "baseURI",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "COMMON_RARITY",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "entranceFee",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "feeAddress",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "player",
				"type": "address"
			}
		],
		"name": "getActivePlayerIndex",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getApproved",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "isApprovedForAll",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "LEGENDARY_RARITY",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ownerOf",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "players",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "previousWinner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "raffleDuration",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "raffleId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "raffleStartTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "RARE_RARITY",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "rarityToName",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "rarityToUri",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes4",
				"name": "interfaceId",
				"type": "bytes4"
			}
		],
		"name": "supportsInterface",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "tokenByIndex",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "tokenIdToRarity",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "tokenOfOwnerByIndex",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "tokenURI",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalFees",
		"outputs": [
			{
				"internalType": "uint64",
				"name": "",
				"type": "uint64"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalSupply",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];
        document.getElementById("walletAddress").innerText = account;

        contract = new web3.eth.Contract(abi, contractAddress);
        document.getElementById("contractAddress").innerText = contractAddress;

        const owner = await contract.methods.owner().call();
        if (owner.toLowerCase() === account.toLowerCase()) {
          document.getElementById("adminSection").classList.remove("hidden");
          document.getElementById("statusText").innerText = "Connected as ADMIN (Owner)";
        } else {
          document.getElementById("statusText").innerText = "Connected as USER";
        }
      } else {
        alert("Please install MetaMask to use this DApp.");
      }
    }

    async function enterRaffle() {
      const rawPlayers = document.getElementById("playerList").value;
      const players = rawPlayers.split(",").map(p => p.trim()).filter(p => p !== "");
      const fee = await contract.methods.entranceFee().call();
      const total = BigInt(fee) * BigInt(players.length);
      try {
        await contract.methods.enterRaffle(players).send({
          from: account,
          value: total.toString()
        });
        alert("Entered successfully!");
      } catch (err) {
        alert("âŒ Error entering: " + err.message);
      }
    }

    // ğŸ§  HÃ m thÃ´ng minh kiá»ƒm tra "0" cÃ³ pháº£i index tháº­t khÃ´ng
  async function getMyIndex() {
  if (!contract || !account) return;
  try {
    const idx = await contract.methods.getActivePlayerIndex(account).call();
    if (Number(idx) === 0) {
      const first = await contract.methods.players(0).call();
      if (first.toLowerCase() === account.toLowerCase()) {
        document.getElementById("myIndexResult").innerText = "ğŸ¯ You are player at index: 0";
      } else {
        document.getElementById("myIndexResult").innerText = "âŒ You are not currently in the raffle.";
      }
    } else {
      document.getElementById("myIndexResult").innerText = "ğŸ¯ You are player at index: " + idx;
    }
  } catch (err) {
    console.error(err);
    document.getElementById("myIndexResult").innerText = "âŒ Error checking index.";
    }
  }


	  
  // async function loadMyNFTs() {
//   if (!contract || !account) return;

//   const nftContainer = document.getElementById("nftContainer");
//   nftContainer.innerHTML = "ğŸ”„ Loading...";

//   try {
//     const balance = await contract.methods.balanceOf(account).call();
//     if (Number(balance) === 0) {
//       nftContainer.innerHTML = "ğŸ˜” You don't own any Puppy NFTs yet.";
//       return;
//     }

//     nftContainer.innerHTML = "<h3>ğŸ“¦ Your NFT TokenURIs:</h3>";

//     for (let i = 0; i < balance; i++) {
//       const tokenId = await contract.methods.tokenOfOwnerByIndex(account, i).call();
//       const uri = await contract.methods.tokenURI(tokenId).call();

//       console.log(`Token #${tokenId} URI:`, uri);

//       const div = document.createElement("div");
//       div.style.padding = "8px";
//       div.style.borderBottom = "1px solid #ddd";
// 	  div.style.wordBreak = "break-word";
//       div.textContent = `Token #${tokenId}: ${uri}`;
//       nftContainer.appendChild(div);
//     }

//   } catch (err) {
//     console.error("âŒ Error loading NFTs:", err);
//     nftContainer.innerHTML = "âŒ Error loading NFTs: " + err.message;
//   }
// }


async function loadMyNFTs() {
  if (!contract || !account) return;

  const nftContainer = document.getElementById("nftContainer");
  nftContainer.innerHTML = "ğŸ”„ Loading...";

  try {
    const balance = await contract.methods.balanceOf(account).call();
    if (Number(balance) === 0) {
      nftContainer.innerHTML = "ğŸ˜” You don't own any Puppy NFTs yet.";
      return;
    }

    nftContainer.innerHTML = "<h3>ğŸ“¦ Your NFT Collection:</h3>";

    for (let i = 0; i < balance; i++) {
      const tokenId = await contract.methods.tokenOfOwnerByIndex(account, i).call();
      const uri = await contract.methods.tokenURI(tokenId).call();

      let nftData = {
        name: `Token #${tokenId}`,
        description: "",
        attributes: [],
        image: ""
      };

      // Chá»‰ xá»­ lÃ½ URI dáº¡ng base64 JSON giá»‘ng báº¡n gá»­i
      if (uri.startsWith("data:application/json;base64,")) {
        try {
          const base64 = uri.split(",")[1];        // bá» prefix
          const jsonStr = atob(base64);            // decode base64
          nftData = JSON.parse(jsonStr);           // parse JSON
        } catch (e) {
          console.warn("âš ï¸ Failed to parse base64 JSON for token", tokenId, e);
        }
      }

      // Táº¡o div hiá»ƒn thá»‹
      const div = document.createElement("div");
      div.style.padding = "8px";
      div.style.borderBottom = "1px solid #ddd";
      div.style.wordBreak = "break-word";

      // Hiá»ƒn thá»‹ thÃ´ng tin NFT
      div.innerHTML = `
        <strong>${nftData.name}</strong><br>
        ${nftData.description}<br>
        <em>Token ID:</em> ${tokenId}<br>
        <em>Traits:</em> ${nftData.attributes.map(a => `${a.trait_type}: ${a.value}`).join(", ")}
      `;

      // Náº¿u cÃ³ áº£nh, hiá»ƒn thá»‹
      if (nftData.image) {
        const img = document.createElement("img");
        if (nftData.image.startsWith("ipfs://")) {
          img.src = nftData.image.replace("ipfs://", "https://ipfs.io/ipfs/");
        } else {
          img.src = nftData.image;
        }
        img.style.width = "150px";
        img.style.height = "150px";
        img.style.display = "block";
        img.style.marginTop = "8px";
        div.appendChild(img);
      }

      nftContainer.appendChild(div);
    }

  } catch (err) {
    console.error("âŒ Error loading NFTs:", err);
    nftContainer.innerHTML = "âŒ Error loading NFTs: " + err.message;
  }
}


	  
    async function refund() {
      const index = document.getElementById("refundIndex").value;
      try {
        await contract.methods.refund(index).send({ from: account });
        alert("Refund successful!");
      } catch (err) {
        alert("âŒ Error refunding: " + err.message);
      }
    }

    async function selectWinner() {
      try {
        await contract.methods.selectWinner().send({ from: account });
        alert("Winner selected!");
      } catch (err) {
        alert("âŒ Error selecting winner: " + err.message);
      }
    }

    async function withdrawFees() {
      try {
        await contract.methods.withdrawFees().send({ from: account });
        alert("Fees withdrawn!");
      } catch (err) {
        alert("âŒ Error withdrawing fees: " + err.message);
      }
    }

    async function changeFeeAddress() {
      const newAddress = document.getElementById("newFeeAddress").value;
      try {
        await contract.methods.changeFeeAddress(newAddress).send({ from: account });
        alert("Fee address changed!");
      } catch (err) {
        alert("âŒ Error changing fee address: " + err.message);
      }
    }
  </script>
</body>
</html>

